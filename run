#!/bin/bash
set -euo pipefail; IFS=$'\n\t'

# 최초 실행인경우 install.php 실행
if [ ! -f /srv/femiwiki.com/LocalSettings.php ]; then
  php /srv/femiwiki.com/maintenance/install.php
    --scriptpath '/w'
    --dbtype mysql --dbserver "${DB:-localhost}" --dbname femiwiki --dbuser root
    --dbpass "${DB_PW:-root}" --installdbuser root --installdbpass "${DB_PW:-root}"
    --server "${PROTOCOL:-https}://${HOST:-femiwiki.com}" --lang ko --pass root '페미위키' Admin

  # Overwrite LocalSettings.php generated by install script
  mv /tmp/LocalSettings.php /srv/femiwiki.com/LocalSettings.php
  sed -i "s/PROTOCOL/${PROTOCOL:-https}/" /srv/femiwiki.com/LocalSettings.php
  sed -i "s/HOST/${HOST:-femiwiki.com}/" /srv/femiwiki.com/LocalSettings.php
fi

# Run update script
/srv/femiwiki.com/maintenance/update.php --quick

# Run cron
cron

# Run php-fpm
php-fpm
